{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Product Recommendations</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        textarea { min-height: 140px; }
        .section-title { font-weight: 600; }
        .email-section { display: none; }
    </style>
</head>

<body class="p-4">

<div class="container mt-4">
    <div class="card p-4">

        <h2 class="text-center mb-4">ðŸ¤– AI Product Recommendation System</h2>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="recTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#content">Content-Based</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#personalized">AI Personalized</a>
            </li>
        </ul>

        <div class="tab-content mt-4">

            <!-- CONTENT BASED -->
            <div class="tab-pane fade show active" id="content">

                <div class="mb-3">
                    <label class="form-label fw-bold">Select Product</label>
                    <select id="product" class="form-select">
                        <option value="">-- Select Product --</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="getRecommendations()">Get Recommendations</button>

                <hr>

                <h5 class="section-title">Recommended Products:</h5>
                <ul id="recommendation-list" class="list-group mt-2"></ul>

            </div>

            <!-- PERSONALIZED -->
            <div class="tab-pane fade" id="personalized">
                <div class="card p-4 mt-3">
                    <h5>AI Personalized Recommendations</h5>

                    <label class="form-label fw-bold">Select Customer</label>
                    <select id="customerDropdown" class="form-select mb-3">
                        <option value="">-- Select Customer --</option>
                    </select>

                    <button class="btn btn-primary" onclick="getPersonalized()">Get Personalized</button>

                    <div id="personalized-result" class="mt-3"></div>
                </div>
            </div>

        </div>

        <hr>

        <!-- MESSAGE TEMPLATES -->
        <h4 class="section-title">ðŸ“© Suggested Message Templates</h4>

        <select id="messageTemplate" class="form-select mb-3">
            <option value="">Select Message Template</option>
            {% for t in templates %}
                <option value="{{ t.id }}"
                        data-body="{{ t.body }}"
                        data-subject="{{ t.subject }}"
                        data-type="{{ t.message_type }}">
                    ({{ t.get_message_type_display }}) {{ t.category }} - {{ t.name }}
                </option>
            {% endfor %}
        </select>

        <!-- EMAIL SUBJECT -->
        <div id="emailSubjectDiv" class="email-section mb-3">
            <label class="form-label fw-bold">Email Subject</label>
            <input id="emailSubject" class="form-control" placeholder="Subject">
        </div>

        <!-- MESSAGE BODY -->
        <label class="form-label fw-bold">Message Body</label>
        <textarea id="messagePreview" class="form-control"></textarea>

        <button class="btn btn-success mt-3" onclick="openSendModal()">Send to Customer</button>

    </div>
</div>

<!-- SEND CONFIRMATION MODAL -->
<div class="modal fade" id="sendConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Send Message?</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Customer:</strong> <span id="confirmCustomer"></span></p>
        <p><strong>Template:</strong> <span id="confirmTemplate"></span></p>
        <p><strong>Preview:</strong></p>
        <div class="border p-2 bg-light" style="white-space: pre-wrap;" id="confirmBody"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" onclick="confirmSend()">Send</button>
      </div>

    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

document.addEventListener("DOMContentLoaded", () => {
    loadProducts();
    loadCustomers();
});

/* ============================================================
   TEMPLATE PLACEHOLDER RENDERING
   ============================================================ */
{% verbatim %}
function renderTemplate(text, data) {
    return text
        .replace(/{{\s*customer_name\s*}}/gi, data.customer_name || "")
        .replace(/{{\s*product\s*}}/gi, data.product || "")
        .replace(/{{\s*recommended_product\s*}}/gi, data.recommended_product || "");
}
{% endverbatim %}

/* LOAD PRODUCTS */
async function loadProducts() {
    const dropdown = document.getElementById('product');

    try {
        const res = await fetch('/api/products/');
        const data = await res.json();
        data.products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            dropdown.appendChild(opt);
        });
    } catch (e) {
        console.error("Error loading products:", e);
    }
}

/* LOAD CUSTOMERS */
async function loadCustomers() {
    const dropdown = document.getElementById('customerDropdown');
    dropdown.innerHTML = `<option value="">Select Customer</option>`;

    try {
        const res = await fetch('/api/customers/');
        const data = await res.json();

        data.customers.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.customer_id;
            opt.textContent = c.customer_name;

            let phone = "";
            if (c.primarycontact && c.primarycontact !== "0") phone = c.primarycontact;
            else if (c.secondarycontact && c.secondarycontact !== "0") phone = c.secondarycontact;
            else if (c.phone && c.phone !== "0") phone = c.phone;

            opt.dataset.phone = phone;
            dropdown.appendChild(opt);
        });

    } catch (e) {
        console.error("Error loading customers:", e);
    }
}

/* CONTENT BASED RECOMMENDATIONS */
function getRecommendations() {
    const product = document.getElementById('product').value;
    const list = document.getElementById('recommendation-list');

    if (!product) {
        list.innerHTML = '<li class="list-group-item text-danger">Select a product.</li>';
        return;
    }

    list.innerHTML = '<li class="list-group-item">Loading...</li>';

    fetch(`/api/recommendations/?product=${product}`)
        .then(res => res.json())
        .then(data => {
            list.innerHTML = '';
            data.recommended_products?.forEach(item => {
                list.innerHTML += `<li class="list-group-item">${item}</li>`;
            });
        });
}

/* PERSONALIZED RECOMMENDATIONS */
function getPersonalized() {
    const customerId = document.getElementById('customerDropdown').value;
    const result = document.getElementById('personalized-result');

    if (!customerId) {
        result.innerHTML = "<p class='text-danger'>Please select a customer.</p>";
        return;
    }

    result.innerHTML = "<p class='text-muted'>Loading...</p>";

    fetch(`/api/recommendations/${customerId}/`)
        .then(res => res.json())
        .then(data => {

            if (data.recommendations?.length) {

                const recommended =
                    data.recommendations[0].product ||
                    data.recommendations[0].name ||
                    data.recommendations[0].title ||
                    "";

                result.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Recommended Product:</strong> ${recommended}
                    </div>
                `;

                // Auto-fill template if already loaded
                const msg = document.getElementById("messagePreview").value;
                const customerDropdown = document.getElementById("customerDropdown");
                const customerName = customerDropdown.options[customerDropdown.selectedIndex]?.text;
                const selectedProduct = document.getElementById("product").value || "";

                document.getElementById("messagePreview").value = renderTemplate(msg, {
                    customer_name: customerName,
                    product: selectedProduct,
                    recommended_product: recommended
                });

            } else {
                result.innerHTML = "<p class='text-danger'>No recommendations found.</p>";
            }
        });
}

/* TEMPLATE SELECTION */
document.getElementById("messageTemplate").addEventListener("change", function () {
    const selected = this.options[this.selectedIndex];

    const rawBody = selected.getAttribute("data-body") || "";
    const subject = selected.getAttribute("data-subject") || "";
    const type = selected.getAttribute("data-type");

    const customerDropdown = document.getElementById("customerDropdown");
    const customerName = customerDropdown.options[customerDropdown.selectedIndex]?.text || "";

    const selectedProduct = document.getElementById("product").value || "";

    let recommendedProduct = "";
    const recommendedLi = document.querySelector("#personalized-result .alert-info");
    if (recommendedLi) {
        recommendedProduct = recommendedLi.textContent.replace("Recommended Product:", "").trim();
    }

    const finalBody = renderTemplate(rawBody, {
        customer_name: customerName,
        product: selectedProduct,
        recommended_product: recommendedProduct
    });

    document.getElementById("messagePreview").value = finalBody;

    if (type === "email") {
        document.getElementById("emailSubjectDiv").style.display = "block";
        document.getElementById("emailSubject").value = subject;
    } else {
        document.getElementById("emailSubjectDiv").style.display = "none";
    }
});

/* OPEN SEND MODAL */
function openSendModal() {

    const customerDropdown = document.getElementById("customerDropdown");
    const customerId = customerDropdown.value;
    const customerName = customerDropdown.options[customerDropdown.selectedIndex]?.text;

    const templateDropdown = document.getElementById("messageTemplate");
    const templateId = templateDropdown.value;
    const templateName = templateDropdown.options[templateDropdown.selectedIndex]?.text;

    if (!customerId) return alert("Please select a customer.");
    if (!templateId) return alert("Please select a template.");

    const messageBody = document.getElementById("messagePreview").value;
    if (!messageBody.trim()) return alert("Message body is empty.");

    const selectedProduct = document.getElementById("product").value || "";

    let recommendedProduct = "";
    const recommendedLi = document.querySelector("#personalized-result .alert-info");
    if (recommendedLi) {
        recommendedProduct = recommendedLi.textContent.replace("Recommended Product:", "").trim();
    }

    const finalPreview = renderTemplate(messageBody, {
        customer_name: customerName,
        product: selectedProduct,
        recommended_product: recommendedProduct
    });

    document.getElementById("confirmCustomer").textContent = customerName;
    document.getElementById("confirmTemplate").textContent = templateName;
    document.getElementById("confirmBody").textContent = finalPreview;

    document.getElementById("confirmBody").dataset.finalMessage = finalPreview;

    const selectedPhone = customerDropdown.options[customerDropdown.selectedIndex].dataset.phone;
    if (!selectedPhone) return alert("This customer does not have a valid phone number.");

    document.getElementById("confirmBody").dataset.phone = selectedPhone;

    const modal = new bootstrap.Modal(document.getElementById("sendConfirmModal"));
    modal.show();
}

/* SEND FINAL MESSAGE */
async function confirmSend() {

    const customerId = document.getElementById("customerDropdown").value;
    const templateId = document.getElementById("messageTemplate").value;

    const confirmBodyElement = document.getElementById("confirmBody");

    const phone = confirmBodyElement.dataset.phone;
    const finalBody = confirmBodyElement.dataset.finalMessage;

    if (!phone) {
        alert("Customer phone number missing.");
        return;
    }

    const payload = {
        customer_id: customerId,
        template_id: templateId,
        phone: phone,
        rendered_message: finalBody
    };

    try {
        const res = await fetch("/api/send-message/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.status === "success") {
            alert("Message sent successfully!");
        } else {
            alert("Failed: " + (data.error || "Unknown error"));
        }

    } catch (e) {
        alert("Network error while sending.");
    }
}

</script>

</body>
</html>
